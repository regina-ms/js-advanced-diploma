!function(){"use strict";var e={1:"prairie",2:"desert",3:"arctic",4:"mountain"};function t(e,t){if(0===e)return"top-left";const s=t*t-1;if(e===s)return"bottom-right";const i=t-1;return e===i?"top-right":e===t*i?"bottom-left":e%t==0?"left":(e+1)%t==0?"right":e>0&&e<i?"top":e>t*i&&e<s?"bottom":"center"}class s{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile",`map-tile-${t(e,this.boardSize)}`),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}this.cells=Array.from(this.boardEl.children),console.log(e)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],i=document.createElement("div");i.classList.add("character",s.character.type);const a=document.createElement("div");a.classList.add("health-level");const o=document.createElement("div");o.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),o.style.width=`${s.character.health}%`,a.appendChild(o),i.appendChild(a),e.appendChild(i)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const i=this.cells[e],a=document.createElement("span");a.textContent=t,a.classList.add("damage"),i.appendChild(a),a.addEventListener("animationend",(()=>{i.removeChild(a),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class i{constructor(e){this.characters=e}}function*a(e,t){for(;;){const s=Math.ceil(Math.random()*t),i=e.length,a=e[Math.floor(Math.random()*i)];yield new a(s)}}function o(e,t,s){const o=[];for(let i=1;i<=s;i++)o.push(a(e,t).next().value);return new i(o)}class r{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,e>1&&this.levelUp(e),this.attack=0,this.defence=0,this.health=50,this.type=t,new.target&&Object.getPrototypeOf(this).constructor===r)throw new Error("Error")}levelUp(e){for(let t=this.level;t<e;t+=1)this.attack=Math.ceil(Math.max(this.attack,this.attack*(80+this.health)/100)),this.defence=Math.ceil(Math.max(this.defence,this.defence*(80+this.health)/100));this.level=e,this.health+=80,this.health>100&&(this.health=100)}}class l{constructor(e,t){if(!(e instanceof r))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class h extends r{constructor(e){super(e),this.type="bowman",this.level=e,this.attack=25,this.defence=25,e>1&&this.levelUp(e)}}class n extends r{constructor(e){super(e),this.level=e,this.type="swordsman",this.attack=40,this.defence=10,e>1&&this.levelUp(e)}}class c extends r{constructor(e){super(e),this.level=e,this.type="magician",this.attack=10,this.defence=40,e>1&&this.levelUp(e)}}class d extends r{constructor(e){super(e),this.level=1,this.type="daemon",this.attack=10,this.defence=10,e>1&&this.levelUp(e)}}class m extends r{constructor(e){super(e),this.level=e,this.type="undead",this.attack=40,this.defence=10,e>1&&this.levelUp(e)}}class u extends r{constructor(e){super(e),this.level=e,this.type="vampire",this.attack=25,this.defence=25,e>1&&this.levelUp(e)}}class p{constructor(e,t,s,i,a,o,r){this.botTeam=e,this.botPlayers=s,this.userPlayers=i,this.userTeam=t,this.level=a,this.currentMoveTeam=r,this.points=o}static from(e){return new p(e.botTeam,e.userTeam,e.botPlayers,e.userPlayers,e.level,e.points,e.currentMoveTeam)}}class y{constructor(e,t){this.gamePlay=e,this.stateService=t,this.teamSize=4,this.teamTypes={bot:[d,m,u],user:[h,n,c]},this.botPlayers=[],this.userPlayers=[],this.points=0,this.level=1}init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.points;this.stateService.load()?this.onLoadGameClick():(this.gamePlay.drawUi(e[1]),this.getPlayersCells(),this.botTeam=o(this.teamTypes.bot,1,this.teamSize),this.userTeam=o(this.teamTypes.user,1,this.teamSize),this.positionCharacters(this.botTeam,this.botCells),this.positionCharacters(this.userTeam,this.userCells),this.positioned=[...this.botPlayers,...this.userPlayers],this.gamePlay.redrawPositions(this.positioned),this.currentMoveTeam="user",this.points=t,this.level=1);const s=this.onCellEnter.bind(this);this.gamePlay.addCellEnterListener(s);const i=this.onCellLeave.bind(this);this.gamePlay.addCellLeaveListener(i);const a=this.onCellClick.bind(this);this.gamePlay.addCellClickListener(a);const r=this.onSaveGameClick.bind(this);this.gamePlay.addSaveGameListener(r);const l=this.onNewGameClick.bind(this);this.gamePlay.addNewGameListener(l);const h=this.onLoadGameClick.bind(this);this.gamePlay.addLoadGameListener(h)}onLoadGameClick(){try{this.state=p.from(this.stateService.load()),this.formTeamsFromState(),this.formPlayersFromState(),this.positioned=[...this.botPlayers,...this.userPlayers],this.level=this.state.level,this.currentMoveTeam=this.state.currentMoveTeam,this.gamePlay.drawUi(e[this.level]),this.gamePlay.redrawPositions(this.positioned),this.points=this.state.points}catch(e){s.showError("Сохранений нет")}}formPlayersFromState(){this.botPlayers=[],this.userPlayers=[],this.state.botPlayers.forEach((e=>{const t=Object.create(l.prototype);Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)),this.botPlayers.push(t)})),this.state.userPlayers.forEach((e=>{const t=Object.create(l.prototype);Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)),this.userPlayers.push(t)}))}formTeamsFromState(){this.botTeam=new i([]),this.userTeam=new i([]),this.state.botTeam.characters.forEach((e=>{const t=Object.create(r.prototype);Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)),this.botTeam.characters.push(t)})),this.state.userTeam.characters.forEach((e=>{const t=Object.create(r.prototype);Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)),this.userTeam.characters.push(t)}))}onSaveGameClick(){this.state=new p(this.botTeam,this.userTeam,this.botPlayers,this.userPlayers,this.level,this.points,this.currentMoveTeam),this.stateService.save(this.state)}onNewGameClick(){this.stateService.storage.clear(),this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.newGameListeners=[],this.gamePlay.saveGameListeners=[],this.gamePlay.loadGameListeners=[],this.botPlayers=[],this.userPlayers=[],this.init(this.points)}setSelected(e){this.selected=this.positioned.find((t=>t.position===e)),this.setAttackArea(this.selected),this.setMoveArea(this.selected)}onCellClick(e){this.gamePlay.deselectCell(e),this.selected&&this.userLogic(e);const t=this.botPlayers.find((t=>t.position===e));if(!this.selected&&t)return void s.showError("Выберите персонажа из своей команды слева");const i=this.userPlayers.find((t=>t.position===e));!this.selected&&i&&(this.setSelected(e),this.gamePlay.selectCell(e))}userLogic(e){const t=this.userPlayers.find((t=>t.position===e)),s=this.botPlayers.find((t=>t.position===e)),i=this.selected.attackArea.find((t=>t===e)),a=this.selected.moveArea.find((t=>t===e));t?(this.gamePlay.deselectCell(this.selected.position),this.setSelected(e),this.gamePlay.selectCell(e)):a&&!s?(this.gamePlay.deselectCell(this.selected.position),this.makeMove(e),this.currentMoveTeam="bot",setTimeout((()=>this.botPlayersLogic()),1e3)):s&&i&&(this.gamePlay.deselectCell(this.selected.position),this.attack(s.position,s).then((()=>{this.points+=10,0===this.botPlayers.length?this.newLevel(this.level+1):(this.currentMoveTeam="bot",setTimeout((()=>this.botPlayersLogic()),1e3))})))}onCellEnter(e){for(const t of this.positioned)if(t.position===e){const s=y.getTooltipMessage`
        \u{1F396}${t.character.level} \u2694${t.character.attack} \u{1F6E1}${t.character.defence} \u2764${t.character.health}
        `;this.gamePlay.showCellTooltip(s,e)}this.selected&&"user"===this.currentMoveTeam?this.setCursor(e):this.gamePlay.setCursor("default")}setCursor(e){const t=this.userPlayers.find((t=>t.position===e)),s=this.botPlayers.find((t=>t.position===e)),i=this.selected.moveArea.find((t=>t===e)),a=this.selected.attackArea.find((t=>t===e));t?this.gamePlay.setCursor("pointer"):s&&a?(this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(e,"red")):i&&!s||0===i&&!s?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor("not-allowed")}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.selected&&this.selected.position!==e&&this.gamePlay.deselectCell(e)}charDied(e){const t=this.botPlayers.find((t=>t===e)),s=this.userPlayers.find((t=>t===e));t?(this.botPlayers.splice(this.botPlayers.indexOf(e),1),this.botTeam.characters.splice(this.botTeam.characters.find((t=>t===e.character)),1)):s&&(this.userPlayers.splice(this.userPlayers.indexOf(e),1),this.userTeam.characters.splice(this.userTeam.characters.find((t=>t===e.character)),1)),this.positioned=this.botPlayers.concat(this.userPlayers)}makeMove(e){const t=this.botPlayers.find((e=>e.position===this.selected.position)),s=this.userPlayers.find((e=>e.position===this.selected.position));t?this.botPlayers.find((e=>e===t)).position=e:s&&(this.userPlayers.find((e=>e===s)).position=e),this.positioned=[...this.botPlayers,...this.userPlayers],this.gamePlay.redrawPositions(this.positioned),this.selected=null}attack(e,t){return new Promise((s=>{const i=t,a=this.selected,o=Math.ceil(Math.max(a.character.attack-i.character.defence,.1*a.character.attack));this.gamePlay.showDamage(e,o).then((()=>{i.character.health-=o,i.character.health<=0&&this.charDied(i),this.gamePlay.redrawPositions(this.positioned),this.selected=null,s()}))}))}newLevel(t){if(t>4)return this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.saveGameListeners=[],void(this.gamePlay.loadGameListeners=[]);this.botPlayers=[],this.userPlayers=[],this.getPlayersCells(),this.botTeam=o(this.teamTypes.bot,1,this.teamSize),this.positionCharacters(this.botTeam,this.botCells);const s=this.getPositions(this.userCells);this.userTeam.characters.forEach(((e,t)=>{this.userPlayers.push(new l(e,s[t]))})),this.positioned=this.userPlayers.concat(this.botPlayers),this.positioned.forEach((e=>{e.character.levelUp(t)})),this.level=t,this.gamePlay.drawUi(e[t]),this.gamePlay.redrawPositions(this.positioned)}botPlayersLogic(){const e=Math.floor(Math.random()*this.botPlayers.length);this.setSelected(this.botPlayers[e].position);const t=this.userPlayers.find((e=>this.selected.attackArea.includes(e.position)));if(t)this.attack(t.position,t),this.currentMoveTeam="user";else{const e=[];for(const t of this.positioned)e.push(t.position);const t=this.selected.moveArea.filter((t=>!e.includes(t))),s=t[Math.floor(Math.random()*t.length)];this.makeMove(s),this.currentMoveTeam="user"}}positionCharacters(e,t){const s=this.getPositions(t);switch(e){case this.botTeam:this.botTeam.characters.forEach(((e,t)=>{this.botPlayers.push(new l(e,s[t]))}));break;case this.userTeam:this.userTeam.characters.forEach(((e,t)=>{this.userPlayers.push(new l(e,s[t]))}))}}getPositions(e){const t=[];for(let s=0;s<this.teamSize;s+=1){const i=Math.floor(Math.random()*(e.length-s));t.push(e[i]),e.splice(i,1)}return t}getPlayersCells(){this.userCells=[],this.botCells=[];for(let e=0;e<this.gamePlay.cells.length;e+=1)e%this.gamePlay.boardSize==0?(this.userCells.push(e),this.userCells.push(e+1)):(e+1)%this.gamePlay.boardSize==0&&(this.botCells.push(e-1),this.botCells.push(e))}getColumn(e,t){const s=[],i=[];for(let i=1;i<=t;i+=1){const t=e-this.gamePlay.boardSize*i;t>=0&&s.push(t)}for(let s=1;s<=t;s+=1){const t=e+this.gamePlay.boardSize*s;t<this.gamePlay.cells.length&&i.push(t)}return i.concat(s)}getRow(e,t){const s=[],i=[];for(let i=1;i<=t&&(e+1)%this.gamePlay.boardSize!=0;i+=1){const t=e+i;if((t+1)%this.gamePlay.boardSize==0){s.push(t);break}s.push(t)}for(let s=1;s<=t&&e%this.gamePlay.boardSize!=0;s+=1){const t=e-s;if(t%this.gamePlay.boardSize==0){i.push(t);break}i.push(t)}return s.concat(i)}getInsideSquare(e,t){const s=this.getRow(e,t);let i=[];for(const e of s)i=i.concat(this.getColumn(e,t));return i}getAcross(e,t){const s=this.getInsideSquare(e,t),i=[];for(let a=1;a<=t;a+=1){const t=(this.gamePlay.boardSize-1)*a;if(e%this.gamePlay.boardSize==0)break;const o=s.find((s=>s===e+t));if(void 0!==o&&i.push(o),o%this.gamePlay.boardSize==0)break}for(let a=1;a<=t;a+=1){const t=(this.gamePlay.boardSize+1)*a,o=s.find((s=>s===e+t));if(void 0!==o&&i.push(o),(o+1)%this.gamePlay.boardSize==0)break}for(let a=1;a<=t;a+=1){const t=(this.gamePlay.boardSize-1)*a,o=s.find((s=>s===e-t));if(void 0!==o&&i.push(o),(o+1)%this.gamePlay.boardSize==0)break}for(let a=1;a<=t;a+=1){const t=(this.gamePlay.boardSize+1)*a,o=s.find((s=>s===e-t));if(void 0!==o&&i.push(o),o%this.gamePlay.boardSize==0)break}return i}setAttackArea(e){switch(e.character.type){case"swordsman":case"undead":e.attackArea=this.getColumn(e.position,1).concat(this.getRow(e.position,1)).concat(this.getInsideSquare(e.position,1));break;case"bowman":case"vampire":e.attackArea=this.getColumn(e.position,2).concat(this.getRow(e.position,2)).concat(this.getInsideSquare(e.position,2));break;case"magician":case"daemon":e.attackArea=this.getColumn(e.position,4).concat(this.getRow(e.position,4)).concat(this.getInsideSquare(e.position,4))}}setMoveArea(e){switch(e.character.type){case"swordsman":case"undead":e.moveArea=this.getColumn(e.position,4).concat(this.getRow(e.position,4)).concat(this.getAcross(e.position,4));break;case"bowman":case"vampire":e.moveArea=this.getColumn(e.position,2).concat(this.getRow(e.position,2)).concat(this.getAcross(e.position,2));break;case"magician":case"daemon":e.moveArea=this.getColumn(e.position,1).concat(this.getRow(e.position,1)).concat(this.getAcross(e.position,1))}}static getTooltipMessage(e){let t="";for(let s=0;s<e.length-1;s+=1)t+=`${e[s]}${s+1<1||arguments.length<=s+1?void 0:arguments[s+1]} `;return t}}const g=new s;g.bindToDOM(document.querySelector("#game-container"));const P=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new y(g,P).init()}();